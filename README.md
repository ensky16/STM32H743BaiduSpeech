# 嵌入式聊天机器人

## 功能
在STM32H743上实现聊天机器人。可以录制10秒钟语音，通过“百度语音API”转换成文字，调用机器人API返回结果，再通过百度语音合成API，将文字合成语音。

## 环境
1. 正点原子的STM H743开发板
2. 正点原子4.3寸RGB电容触摸液晶屏模块，480*272分辨率，RGB接口。
3. ST-Link或者ULink2 
4. Keil MDK uVisionV5.14.0.0 
5. Ubuntu LTS16.04_x64 
6. Apache/2.4.18 (Ubuntu) 
7. PHP 7.0.33-0ubuntu0.16.04.12 (cli) ( NTS )
> 以上环境中Keil MKD, Ubuntu, Apache, PHP都可以使用其余版本。

## 思路
1. 在STM32H743上移植FreeRTOS+LWIP，使用lwip的Socket模拟一个POST方法。开发板与外界的数据交互使用POST实现。
2. 需要一个中间服务器做数据转发，因为百度语音需要16K的采样率。将STM32 H743的录音Demo，采样率设置为16000后，声音特别模糊，听不清。所以可以使用44.1K的采样率录音，将录音数据发送到“中间服务器”，在这个中间服务器上将数据转为16000的采样率，再发起百度语音识别请求，获取解析后的“文字”。
3. 将转换后的文字通过机器人API获取聊天结果。
4. 通过百度语音合成API，将机器人返回的结果合成语音。
5. 将合成的语音发送到开发板，播放出来。

> - 如果不使用中间服务器做转发，也可以直接在STM32H743开发板上发送POST请求到百度语音服务器，获取识别结果。
> - 方法1, 录音元件可以直接使用16k的采样率采样，我试验过，使用当前的开发板，将采样率改为16K，单声道，发送POST请求到百度语音服务器，可以返回结果，就是结果不对，因为录音本身就比较模糊，听不清。
> - 方法2，可以使用44.1k的采样率采样，然后将这个44.1K转换16K单声道，再发送POST请求到百度语音服务器。


## 移植

**1. 将代码下载到本机，Master分支**
- 使用Keil编译代码，工程文件位于STM32H743\USER目录下。连接好屏幕和串口线。

**2. 搭建一个转发服务器**
- 使用ubuntu系统搭建一个PHP运行环境。我使用的是apache+PHP。安装apache，需要支持PHP。
- 在apache的根目录中新建一个文件夹php2。例如：/var/www/html/php2
- 将Server文件夹下的post.php和baidu_speech.php复制到文件夹php2中，设置两个文件的权限为可读写。
- 将php2文件夹的权限设置为“可读写”。注意目录权限，开发板的录音数据需要上传“php2"中，如果php2文件夹不允许写，就会有问题。
- 服务器上需要安装ffmpeg工具，转换音频用的。

**3. 按键使用**
- 下载成功以后，屏幕会显示对应信息，按键“KEY0”是录音，最长可以录制10秒钟。
- 按键“KEY2”，发送数据到ubuntu服务器，结果会返回到开发板上。

> 如果使用虚拟机搭建ubuntu服务器，注意本机以及虚拟机的防火墙设置，使用虚拟机ping一下开发板，保证可以ping通。